<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="row g-0">
                <div class="col-sm-6 col-md-8 checkout-left">
                    <div class="checkout-logo">
                        <a href="/index.html">
                            <img src="https://bizweb.dktcdn.net/100/465/740/themes/884110/assets/checkout_logo.png?1675246865179" alt="" class="checkout-logo__img">
                        </a>
                    </div>
                    <div class="checkout-body row justify-content-center">
                        <div class="col-6">
                            <form class="left-form" >
                                <header class="form-header">Thông tin nhận hàng</header>
                                <div class="form-floating">
                                    <input type="email" class="form-control email-input" id="floatingInput" placeholder="name@example.com">
                                    <label for="floatingInput">Email</label>
                                    <div class="form-message"></div>
                                </div>
                                <div class="form-floating">
                                    <input type="email" class="form-control name-input" id="floatingInput" placeholder="name@example.com">
                                    <label for="floatingInput">Họ và tên</label>
                                    <div class="form-message"></div>
                                </div>
                                <div class="form-floating">
                                    <input type="email" class="form-control phone-input" id="floatingInput" placeholder="name@example.com">
                                    <label for="floatingInput">Số điện thoại (tùy chọn)</label>
                                </div>
                                <div class="form-floating">
                                    <input type="email" class="form-control address-input" id="floatingInput" placeholder="name@example.com">
                                    <label for="floatingInput">Địa chỉ</label>
                                    <div class="form-message"></div>
                                </div>
                                <div class="form-floating">
                                    <select class="form-select city" id="floatingSelect" aria-label="Floating label select example">
                                      <option selected>---</option>
                                      <option value="hanoi">Hà Nội</option>
                                      <option value="tphcm">TP.HCM</option>
                                      <option value="danang">Đà Nẵng</option>
                                    </select>
                                    <label for="floatingSelect">Tỉnh thành</label>
                                </div>
                                <div class="form-floating">
                                    <select class="form-select district" id="floatingSelect" aria-label="Floating label select example">
                                      <option selected>---</option>
                                      <option value="1">One</option>
                                      <option value="2">Two</option>
                                      <option value="3">Three</option>
                                    </select>
                                    <label for="floatingSelect">Quận huyện</label>
                                </div>
                                <div class="form-floating">
                                    <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 100px"></textarea>
                                    <label for="floatingTextarea2">Comments</label>
                                </div>
                            </form>
                        </div>
                        <div class="col-6 form-right">
                            <header class="form-header">Vận chuyển</header>
                            <div class="form-check checkout-check">
                                <input class="form-check-input check-input" type="checkbox" name="exampleRadios" id="shipping-check" value="option1">
                                <label class="form-check-label" for="shipping-check">
                                  Giao hàng tận nơi
                                </label>
                                <span class="check-shipping__price"></span>
                            </div>
                            <header class="form-header">Thanh toán</header>
                            <div class="form-check checkout-check">
                                <input class="form-check-input" type="checkbox" name="exampleRadios" id="shipping-check" value="option1" checked>
                                <label class="form-check-label" for="shipping-check">
                                  Thanh toán khi nhận hàng
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-4 checkout-right">
                    <div id="header-checkout" class="form-header">Đơn hàng</div>
                    <div class="right-body">
                        <!-- <div class="checkout-item">
                            <div class="checkout-item__thumb">
                                <img src="https://www.highlandscoffee.com.vn/vnt_upload/product/11_2022/BR_Drink/thumbs/270_crop_HLC_New_logo_Products__FREEZE_TRA_XANH.png" alt="" class="checkout-item__img">
                            </div>
                            <div class="checkout-item__info">
                                Cà phê sữa đá
                            </div>
                            <div class="checkout-item__price">
                                270.000đ
                            </div>
                        </div>
                        <div class="checkout-item">
                            <div class="checkout-item__thumb">
                                <img src="https://www.highlandscoffee.com.vn/vnt_upload/product/11_2022/BR_Drink/thumbs/270_crop_HLC_New_logo_Products__FREEZE_TRA_XANH.png" alt="" class="checkout-item__img">
                            </div>
                            <div class="checkout-item__info">
                                Cà phê sữa đá
                            </div>
                            <div class="checkout-item__price">
                                270.000đ
                            </div>
                        </div> -->
                    </div>
                    <div class="right-discount input-group input-group-lg">
                        <input type="text" class="form-control" placeholder="Mã khuyễn mại" aria-label="Recipient's username" aria-describedby="button-addon2">
                        <button class="btn discount-button" type="button" id="button-addon2">Áp dụng</button>
                    </div>

                    <div class="order-summary">
                        <div class="order-section checkout-subtotal">
                            Tạm tính
                            <span class="subtotal-num">2443000</span>
                        </div>
                        <div class="order-section shipping">
                            Phí vận chuyển
                            <span class="shipping-num"></span>
                        </div>
                    </div>
                    <div class="checkout-total">
                        <div class="order-section total">
                            Tổng cộng
                            <span class="total-num">---</span>
                        </div>
                        <div class="checkout-right__footer">
                            <a href="/product.html" class="back">
                                <i class="fa-solid fa-angle-left icon-left"></i>
                                Quay trở về giỏ hàng
                            </a>
                            <button class="btn order-btn">Đặt hàng</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer menu-footer"></footer>
    </div>

    <script>
        const $ = document.querySelector.bind(document)
        const $$ = document.querySelectorAll.bind(document)
        
        const list = JSON.parse(localStorage.getItem('LIST')) 
        const checkoutList = $('.right-body')
        const header = $('#header-checkout')
        const subTotalCheckout = $('.subtotal-num')
        const totalCheckout = $('.total-num')
        const city = $('.city')
        const district = $('.district')
        const shippingCost = $('.shipping-num')
        const checkBox = $('.check-input')
        const inputPrice = $('.check-shipping__price')

        
        const app = {
            hanoi: [
                'Ba Đình',
                'Bắc Từ Liêm',
                'Cầu Giấy',
                'Đống Đa',
                'Hà Đông',
                'Hai Bà Trưng',
                'Hoàn Kiếm',
                'Hoàng Mai',
                'Long Biên',
                'Nam Từ Liêm',
                'Tây Hồ',
                'Thanh Xuân',
            ],
            tphcm: [
                'Thành phố Thủ Đức',
                'Quận 1',
                'Quận 3',
                'Quận 4',
                'Quận 5',
                'Quận 6',
                'Quận 7',
                'Quận 8',
                'Quận 10',
                'Quận 11',
                'Quận 12',
                'Quận Bình Tân',
                'Quận Bình Thạnh',
                'Quận Tân Bình',
            ],
            danang: [
                'Huyện Hoàng Sa',
                'Huyện Hoà Vang',
                'Quận Thanh Khê',
                'Quận Sơn Trà',
                'Quận Ngũ Hành Sơn',
                'Quận Liên Chiểu',
                'Quận Hải Châu',
                'Quận Cẩm Lệ',
            ],
        }

        let inputRender = null
        let shipPrice = 0

        city.onchange = function () {
            inputRender = app[city.value]
            if (city.value === 'danang') {
                shipPrice = 40000
            } else {
                shipPrice = 30000
            }
            renderInput()
            render()
        }

        function renderInput () {
            const inputHtml = inputRender.map(item => {
                return `
                    <option value=${item}>${item}</option>
                `
            })
            district.innerHTML = inputHtml
        }



        function Validator (options) {
    
    var selectorRules = {}

    function validate (inputE, rule) {

        var errorMessage
        var errorPan = inputE.parentElement.querySelector(options.errorSelector)
        var rules = selectorRules[rule.selector]


        // Lặp qua từng rule và kiểm tra
        // Nếu có lỗi thì dừng việc kiểm tra
        for (var i = 0; i < rules.length; ++i) {
            errorMessage = rules[i](inputE.value);
            if (errorMessage) break;
        }

        if (errorMessage) {
            inputE.parentElement.classList.add('invalid')
            errorPan.innerText = errorMessage
           }
           else{
            inputE.parentElement.classList.remove('invalid')
            errorPan.innerText = ''
           }
           return !errorMessage
    }

    var formElement = document.querySelector(options.form)


    // khi submit form
    formElement.onsubmit = function (e) {
        e.preventDefault()

        var isValid = true

        options.rules.forEach(function (rule) {
            var inputE = formElement.querySelector(rule.selector)
            var valid =  validate(inputE, rule)
            if (!valid){
                isValid = false;
            }
        })

        if (isValid){
            if (typeof options.onSubmit === 'function') {
                var enableInputs = formElement.querySelectorAll('[name]');

                var formValues = Array.from(enableInputs).reduce(function (values, input){
                    (values[input.name] = input.value)
                    return values;
                }, {});
                options.onSubmit(formValues)
            }
        }
    }


    if (formElement) {
        options.rules.forEach(function (rule) {

            if (Array.isArray(selectorRules[rule.selector])){
                selectorRules[rule.selector].push(rule.test)
            }
            else {
                selectorRules[rule.selector] = [rule.test]
            }

            var inputE = formElement.querySelector(rule.selector);

            if (inputE) {
                var errorMessage = rule.test(inputE.value)

                inputE.onblur = function () {
                    validate(inputE, rule)
                }

                inputE.oninput = function () {
                    var errorPan = inputE.parentElement.querySelector(options.errorSelector)
                    inputE.parentElement.classList.remove('invalid')
                    errorPan.innerText = ''
                }
            }
        })
    }
}


// Định nghĩa rule
// Nguyên tăc các rules:
// 1. Khi có lỗi => trả message lỗi
// 2. Khi hợp lệ => trả undefined
Validator.isRequired = function (selector) {
    return {
        selector: selector,
        test: function (value) {
            return value.trim() ? undefined : 'Vui lòng nhập trường này'
        }
}
}

Validator.isEmail = function (selector) {
    return {
        selector: selector,
        test: function (value) {
            var regex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/
            return regex.test(value) ? undefined : 'Trường này phải là email'

        }
}
}


Validator({
            form: '.left-form',
            errorSelector: '.form-message',
            rules: [
                Validator.isRequired('.name-input'),
                Validator.isRequired('.email-input'),
                Validator.isEmail('.email-input'),
                Validator.isRequired('.address-input'),
            ],
            onSubmit: function (data) {
              console.log(data)
            }
        })




const render = function() {
        let totalItems = 0;
        let subTotal = 0;
        list.forEach(item => {
             totalItems += item.quantity
             subTotal += item.quantity * item.price
             
        })

        inputPrice.innerText = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'VND' }).format(shipPrice)

        checkBox.onchange = function() {
            shippingCost.innerText = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'VND' }).format(shipPrice)
        }
   

        const formatSubTotal = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'VND' }).format(subTotal)
        totalCheckout.innerText = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'VND' }).format(subTotal + shipPrice)



            header.innerText = `Đơn hàng (${totalItems} đơn hàng) ` 
            subTotalCheckout.innerText = `${formatSubTotal}`

            const checkoutHtmls = list.map(item => {
                return `
                    <div class="checkout-item">
                        <div class="checkout-item__thumb">
                            <img src=${item.path} alt="" class="checkout-item__img">
                            <span class="checkout-item__num">${item.quantity}</span>
                        </div>
                        <div class="checkout-item__info">
                            ${item.title}
                        </div>
                        <div class="checkout-item__price">
                            ${new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'VND' }).format(item.quantity * item.price)}
                        </div>
                    </div>
                `
            })
            checkoutList.innerHTML = checkoutHtmls.join('')

        }

render()

    </script>
    <script src="/code.js"></script>

</body>
</html>